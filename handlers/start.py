from aiogram import Router, types
from aiogram.filters import Command
from database import Database
from keyboards import get_main_kb_no_family, get_main_kb_with_family

router = Router()
db = Database('space.db')


@router.message(Command("start"))
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username or "SpaceTraveller"

    # –†–µ—î—Å—Ç—Ä—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫—â–æ –π–æ–≥–æ —â–µ –Ω–µ–º–∞—î
    db.add_user(user_id, username)

    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—ñ–Ω –≤–∂–µ –≤ —Å—ñ–º'—ó
    family_id = db.get_user_family(user_id)

    if family_id:
        # --- –í–ê–†–Ü–ê–ù–¢ 1: –ì–†–ê–í–ï–¶–¨ –í–ñ–ï –ú–ê–Ñ –ö–û–ú–ê–ù–î–£ ---
        info = db.get_family_info(family_id)
        # info: 0=name, 1=code, 2=balance, 3=engine, 4=hull, 5=planet

        family_name = info[0]
        current_planet = info[5]

        welcome_text = (
            f"üßë‚ÄçüöÄ **–ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º –Ω–∞ –±–æ—Ä—Ç, –∫–∞–ø—ñ—Ç–∞–Ω–µ!**\n\n"
            f"–¢–≤–æ—è –∫–æ–º–∞–Ω–¥–∞ **¬´{family_name}¬ª** —á–µ–∫–∞—î –Ω–∞ –Ω–∞–∫–∞–∑–∏.\n"
            f"üìç –ü–æ—Ç–æ—á–Ω–∞ –ª–æ–∫–∞—Ü—ñ—è: **{current_planet}**\n"
            f"‚öôÔ∏è –°–∏—Å—Ç–µ–º–∏ –∫–æ—Ä–∞–±–ª—è: **–í –ù–û–†–ú–Ü**\n\n"
            f"–¢–∏—Å–Ω–∏ **¬´üì° –ú—ñ—Å—ñ—ó¬ª**, —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø—ñ–¥–∫–æ—Ä–µ–Ω–Ω—è –∫–æ—Å–º–æ—Å—É, "
            f"–∞–±–æ –≤—ñ–¥–∫—Ä–∏–π **–í–µ–±-–¥–æ–¥–∞—Ç–æ–∫**, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–≤—ñ–π –∫–æ—Ä–∞–±–µ–ª—å!"
        )

        await message.answer(welcome_text, parse_mode="Markdown", reply_markup=get_main_kb_with_family())

    else:
        # --- –í–ê–†–Ü–ê–ù–¢ 2: –ù–û–í–ê–ß–û–ö (–ë–ï–ó –ö–û–ú–ê–ù–î–ò) ---
        intro_text = (
            f"üëã **–í—ñ—Ç–∞—é –≤ —Ü–µ–Ω—Ç—Ä—ñ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–æ–ª—å–æ—Ç–∞–º–∏ Rocket Lab!**\n\n"
            f"–¢–∏ ‚Äî —Ç–∞–ª–∞–Ω–æ–≤–∏—Ç–∏–π —ñ–Ω–∂–µ–Ω–µ—Ä, –∞–ª–µ –∫–æ—Å–º–æ—Å –Ω–µ –ø—ñ–¥–∫–æ—Ä—é—é—Ç—å –ø–æ–æ–¥–∏–Ω—Ü—ñ. "
            f"–¢–æ–±—ñ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –Ω–∞–¥—ñ–π–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ (–°—ñ–º'—è), —â–æ–± –ø–æ–±—É–¥—É–≤–∞—Ç–∏ —Ä–∞–∫–µ—Ç—É —ñ –¥–æ–ª–µ—Ç—ñ—Ç–∏ –≤—ñ–¥ –ó–µ–º–ª—ñ –¥–æ –°–∞—Ç—É—Ä–Ω–∞! ü™ê\n\n"
            f"üëæ **–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:**\n"
            f"1. **Telegram-–±–æ—Ç:** –¢—É—Ç —Ç–∏ –∫–µ—Ä—É—î—à –∫–æ–º–∞–Ω–¥–æ—é, –±—é–¥–∂–µ—Ç–æ–º —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î—à –º—ñ—Å—ñ—ó.\n"
            f"2. **–í–µ–±-–¥–æ–¥–∞—Ç–æ–∫:** –¢—É—Ç —Ç–∏ –±–∞—á–∏—à –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é –ø–æ–ª—å–æ—Ç—ñ–≤ —Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å.\n"
            f"3. **–ö–æ–º–∞–Ω–¥–∞:** –ú—ñ—Å—ñ—ó –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —Ä–∞–∑–æ–º! –í—Å—ñ –º–∞—é—Ç—å –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É ¬´–ì–æ—Ç–æ–≤–∏–π¬ª.\n\n"
            f"üëá **–©–æ–± –ø–æ—á–∞—Ç–∏, –æ–±–µ—Ä–∏ –¥—ñ—é:**\n"
            f"–°—Ç–≤–æ—Ä–∏ –Ω–æ–≤—É —Å—ñ–º'—é –∞–±–æ –ø—Ä–∏—î–¥–Ω–∞–π—Å—è –¥–æ –¥—Ä—É–∑—ñ–≤ –∑–∞ –∫–æ–¥–æ–º."
        )

        await message.answer(intro_text, parse_mode="Markdown", reply_markup=get_main_kb_no_family())